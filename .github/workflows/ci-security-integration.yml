name: Security & Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  docker-tests:
    name: Docker Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio
          pip install pydantic pydantic-settings docker openai anthropic google-generativeai aiodocker mistletoe
          pip install -e .
      
      - name: Verify Docker
        run: docker --version
      
      - name: Test egress filtering
        run: python -c "from rlm.security.egress import detect_secrets; assert len(detect_secrets('AKIAIOSFODNN7EXAMPLE')) > 0; print('OK')"

  parsing-tests:
    name: Parsing Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install mistletoe pytest
          pip install -e .
      
      - name: Test parsing
        run: python -c "from rlm.core.parsing import extract_final_answer; assert extract_final_answer('FINAL(42)') == '42'; print('OK')"
      
      - name: Run unit tests
        run: pytest tests/unit/ -v --tb=short

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [docker-tests, parsing-tests]
    if: always()
    steps:
      - name: Results
        run: |
          echo "## Security Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: ${{ needs.docker-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Parsing: ${{ needs.parsing-tests.result }}" >> $GITHUB_STEP_SUMMARY
