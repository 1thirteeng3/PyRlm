name: Security & Integration Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  docker-tests:
    name: Docker Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio
          pip install pydantic pydantic-settings docker openai anthropic google-generativeai aiodocker mistletoe
          pip install -e .
      
      - name: Verify Docker is available
        run: |
          docker --version
          docker info | head -20
      
      - name: Pull test image
        run: docker pull python:3.11-slim
      
      - name: Run basic Docker tests
        run: |
          echo "Testing Docker availability..."
          docker run --rm python:3.11-slim python -c "print('Docker works!')"
          echo "✅ Docker test passed"
        
      - name: Test egress filtering
        run: |
          python -c "
          from rlm.security.egress import detect_secrets, calculate_shannon_entropy
          
          # Test secret detection
          assert len(detect_secrets('AKIAIOSFODNN7EXAMPLE')) > 0, 'AWS key not detected'
          print('✅ AWS key detection works')
          
          # Test entropy
          entropy = calculate_shannon_entropy('sk-a1b2c3d4e5f6g7h8i9j0')
          assert entropy > 3.5, f'Entropy too low: {entropy}'
          print(f'✅ Entropy detection works (entropy={entropy:.2f})')
          
          print('All egress tests passed!')
          "

  parsing-tests:
    name: Parsing Robustness Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install mistletoe
          pip install -e .
      
      - name: Test robust parsing
        run: |
          python -c "
          from rlm.core.parsing import extract_python_code, extract_final_answer
          
          # Test basic code extraction
          md = '''Here is code:
          \`\`\`python
          print('hello')
          \`\`\`
          '''
          codes = extract_python_code(md)
          assert len(codes) == 1, f'Expected 1 code block, got {len(codes)}'
          print('✅ Basic extraction works')
          
          # Test FINAL detection
          text = 'The answer is FINAL(42)'
          final = extract_final_answer(text)
          assert final == '42', f'Expected 42, got {final}'
          print('✅ FINAL detection works')
          
          print('All parsing tests passed!')
          "

  security-status:
    name: Security Tests Status
    runs-on: ubuntu-latest
    needs: [docker-tests, parsing-tests]
    if: always()
    steps:
      - name: Report status
        run: |
          echo "Docker Tests: ${{ needs.docker-tests.result }}"
          echo "Parsing Tests: ${{ needs.parsing-tests.result }}"
          if [[ "${{ needs.docker-tests.result }}" == "success" ]] && \
             [[ "${{ needs.parsing-tests.result }}" == "success" ]]; then
            echo "✅ All Security Tests Passed"
          else
            echo "⚠️ Some tests had issues - review logs"
          fi
