name: Dependency Audit

on:
  # Run weekly on Monday at 9am UTC
  schedule:
    - cron: '0 9 * * 1'
  # Run on every push to main (for immediate feedback)
  push:
    branches: [main]
    paths:
      - 'pyproject.toml'
      - 'requirements*.txt'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  pip-audit:
    name: pip-audit Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          pip install -e .
      
      - name: Run pip-audit
        run: |
          echo "=== Scanning for vulnerabilities ==="
          pip-audit --strict --progress-spinner off || true
          
          # Generate SARIF output for GitHub Security tab
          pip-audit --format=json --output=audit-results.json || true
      
      - name: Check for critical vulnerabilities
        run: |
          python -c "
          import json
          import sys
          
          try:
              with open('audit-results.json') as f:
                  results = json.load(f)
          except:
              print('No audit results found')
              sys.exit(0)
          
          if not results:
              print('‚úÖ No vulnerabilities found')
              sys.exit(0)
          
          critical = []
          high = []
          
          for vuln in results:
              name = vuln.get('name', 'unknown')
              vulns = vuln.get('vulns', [])
              
              for v in vulns:
                  severity = v.get('severity', 'unknown')
                  vid = v.get('id', 'unknown')
                  
                  if severity in ['critical', 'CRITICAL']:
                      critical.append(f'{name}: {vid}')
                  elif severity in ['high', 'HIGH']:
                      high.append(f'{name}: {vid}')
          
          if critical:
              print('‚ùå CRITICAL vulnerabilities found:')
              for c in critical:
                  print(f'  - {c}')
              sys.exit(1)
          
          if high:
              print('‚ö†Ô∏è HIGH severity vulnerabilities found:')
              for h in high:
                  print(f'  - {h}')
              # Don't fail on high, but warn
          
          print('‚úÖ No critical vulnerabilities')
          "
      
      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-results
          path: audit-results.json
          retention-days: 30

  safety-check:
    name: Safety Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install safety
        run: pip install safety
      
      - name: Run safety check
        run: |
          pip install -e .
          pip freeze > requirements-frozen.txt
          safety check -r requirements-frozen.txt --full-report || true
        continue-on-error: true

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install pip-licenses
        run: |
          pip install pip-licenses
          pip install -e .
      
      - name: Check licenses
        run: |
          echo "=== Dependency Licenses ==="
          pip-licenses --format=markdown --with-urls
          
          echo ""
          echo "=== Checking for problematic licenses ==="
          
          # Check for GPL (copyleft) licenses that might conflict with MIT
          PROBLEMATIC=$(pip-licenses --format=csv | grep -iE "GPL|AGPL|LGPL" | head -20 || true)
          
          if [ -n "$PROBLEMATIC" ]; then
            echo "‚ö†Ô∏è Potentially problematic licenses found:"
            echo "$PROBLEMATIC"
          else
            echo "‚úÖ No problematic licenses found"
          fi

  notify-on-failure:
    name: Notify on Critical Issues
    runs-on: ubuntu-latest
    needs: [pip-audit, safety-check]
    if: failure()
    
    steps:
      - name: Create issue for vulnerabilities
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Security: Dependency vulnerabilities detected';
            const body = `
            ## Dependency Audit Failed
            
            The weekly dependency audit has detected potential vulnerabilities.
            
            **Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ### Action Required
            1. Review the audit results
            2. Update affected dependencies
            3. Re-run the audit to verify fixes
            
            ---
            *This issue was automatically created by the dependency audit workflow.*
            `;
            
            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'dependencies', 'automated']
              });
            }
